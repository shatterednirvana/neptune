<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>module NeptuneHelper - RDoc Documentation</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="module">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>lib/neptune.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    
    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-c-compile_code">::compile_code</a>
    
    <li><a href="#method-c-do_preprocessing">::do_preprocessing</a>
    
    <li><a href="#method-c-get_input">::get_input</a>
    
    <li><a href="#method-c-get_job_data">::get_job_data</a>
    
    <li><a href="#method-c-get_std_out_and_err">::get_std_out_and_err</a>
    
    <li><a href="#method-c-preprocess_babel">::preprocess_babel</a>
    
    <li><a href="#method-c-preprocess_compile">::preprocess_compile</a>
    
    <li><a href="#method-c-preprocess_erlang">::preprocess_erlang</a>
    
    <li><a href="#method-c-preprocess_mpi">::preprocess_mpi</a>
    
    <li><a href="#method-c-preprocess_ssa">::preprocess_ssa</a>
    
    <li><a href="#method-c-require_file_to_exist">::require_file_to_exist</a>
    
    <li><a href="#method-c-require_file_to_not_exist">::require_file_to_not_exist</a>
    
    <li><a href="#method-c-require_param">::require_param</a>
    
    <li><a href="#method-c-run_job">::run_job</a>
    
    <li><a href="#method-c-upload_app_for_cicero">::upload_app_for_cicero</a>
    
    <li><a href="#method-c-validate_storage_params">::validate_storage_params</a>
    
    <li><a href="#method-c-wait_for_compilation_to_finish">::wait_for_compilation_to_finish</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    
    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./BabelHelper.html">BabelHelper</a>
  
    <li><a href="./BadConfigurationException.html">BadConfigurationException</a>
  
    <li><a href="./CommonFunctions.html">CommonFunctions</a>
  
    <li><a href="./ExodusHelper.html">ExodusHelper</a>
  
    <li><a href="./ExodusTaskInfo.html">ExodusTaskInfo</a>
  
    <li><a href="./FileNotFoundException.html">FileNotFoundException</a>
  
    <li><a href="./NeptuneHelper.html">NeptuneHelper</a>
  
    <li><a href="./NeptuneManagerClient.html">NeptuneManagerClient</a>
  
    <li><a href="./NeptuneManagerException.html">NeptuneManagerException</a>
  
    <li><a href="./Object.html">Object</a>
  
    <li><a href="./TaskInfo.html">TaskInfo</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="module">module NeptuneHelper</h1>

  <div id="description" class="description">
    
<p><a href="NeptuneHelper.html">NeptuneHelper</a> provides methods that are
used by neptune() and babel() to  validate parameters and run the user’s
job.</p>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    <!-- Methods -->
    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-compile_code" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">compile_code</span><span
            class="method-args">(job_data, ssh_args, shadow_ip)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This method sends out a request to compile code, waits for it to finish,
and gets the standard out and error returned from the compilation. This
method returns a hash containing the standard out, error, and a result that
indicates whether or not the compilation was successful.</p>
          

          
          <div class="method-source-code" id="compile_code-source">
            <pre><span class="ruby-comment"># File lib/neptune.rb, line 459</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">compile_code</span>(<span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">ssh_args</span>, <span class="ruby-identifier">shadow_ip</span>)
  <span class="ruby-identifier">compiled_location</span> = <span class="ruby-identifier">controller</span>.<span class="ruby-identifier">compile_code</span>(<span class="ruby-identifier">job_data</span>)
  <span class="ruby-identifier">copy_to</span> = <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@copy_to&quot;</span>]
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">wait_for_compilation_to_finish</span>(<span class="ruby-identifier">ssh_args</span>, <span class="ruby-identifier">shadow_ip</span>, <span class="ruby-identifier">compiled_location</span>)

  <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_rf</span>(<span class="ruby-identifier">copy_to</span>)

  <span class="ruby-identifier">scp_command</span> = <span class="ruby-node">&quot;scp -r #{ssh_args} root@#{shadow_ip}:#{compiled_location} #{copy_to} 2&gt;&amp;1&quot;</span>
  <span class="ruby-comment"># Kernel.puts scp_command</span>
  <span class="ruby-constant">CommonFunctions</span>.<span class="ruby-identifier">shell</span>(<span class="ruby-identifier">scp_command</span>)

  <span class="ruby-identifier">code</span> = <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@code&quot;</span>]
  <span class="ruby-identifier">dirs</span> = <span class="ruby-identifier">code</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp">%r\//</span>)
  <span class="ruby-identifier">remote_dir</span> = <span class="ruby-string">&quot;/tmp/&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">dirs</span>[<span class="ruby-value">-1</span>] 

  [<span class="ruby-identifier">remote_dir</span>, <span class="ruby-identifier">compiled_location</span>].<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">remote_files</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">ssh_command</span> = <span class="ruby-node">&quot;ssh #{ssh_args} root@#{shadow_ip} 'rm -rf #{remote_files}' 2&gt;&amp;1&quot;</span>
    <span class="ruby-comment"># Kernel.puts ssh_command</span>
    <span class="ruby-constant">CommonFunctions</span>.<span class="ruby-identifier">shell</span>(<span class="ruby-identifier">ssh_command</span>)
  }

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">get_std_out_and_err</span>(<span class="ruby-identifier">copy_to</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- compile_code-source -->
          
        </div>

        

        
      </div><!-- compile_code-method -->

    
      <div id="method-c-do_preprocessing" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">do_preprocessing</span><span
            class="method-args">(job_data, controller)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Certain types of jobs need steps to be taken before they can be started
(e.g., copying input data or code over). This method dispatches the right
method to use based on the type of the job that the user has asked to run.</p>
          

          
          <div class="method-source-code" id="do_preprocessing-source">
            <pre><span class="ruby-comment"># File lib/neptune.rb, line 114</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">do_preprocessing</span>(<span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">controller</span>)
  <span class="ruby-identifier">job_type</span> = <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@type&quot;</span>]
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">NEED_PREPROCESSING</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">job_type</span>)
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Don't worry about adding on the self. prefix - send will resolve</span>
  <span class="ruby-comment"># it the right way</span>
  <span class="ruby-identifier">preprocess</span> = <span class="ruby-node">&quot;preprocess_#{job_type}&quot;</span>.<span class="ruby-identifier">to_sym</span>
  <span class="ruby-identifier">send</span>(<span class="ruby-identifier">preprocess</span>, <span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">controller</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- do_preprocessing-source -->
          
        </div>

        

        
      </div><!-- do_preprocessing-method -->

    
      <div id="method-c-get_input" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_input</span><span
            class="method-args">(job_data, ssh_args, shadow_ip, controller)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This method takes a file on the local user’s computer and stores it
remotely via AppScale. It returns a hash map indicating whether or not the
job succeeded and if it failed, the reason for it.</p>
          

          
          <div class="method-source-code" id="get_input-source">
            <pre><span class="ruby-comment"># File lib/neptune.rb, line 407</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_input</span>(<span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">ssh_args</span>, <span class="ruby-identifier">shadow_ip</span>, <span class="ruby-identifier">controller</span>)
  <span class="ruby-identifier">result</span> = {<span class="ruby-value">:result</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:success</span>}

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_param</span>(<span class="ruby-string">&quot;@local&quot;</span>, <span class="ruby-identifier">job_data</span>)

  <span class="ruby-identifier">local_file</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@local&quot;</span>])
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">local_file</span>)
    <span class="ruby-identifier">reason</span> = <span class="ruby-node">&quot;the file you specified to copy, #{local_file}, doesn't exist.&quot;</span> <span class="ruby-operator">+</span> 
        <span class="ruby-string">&quot; Please specify a file that exists and try again.&quot;</span>
    <span class="ruby-keyword">return</span> {<span class="ruby-value">:result</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:failure</span>, <span class="ruby-value">:reason</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">reason</span>}  
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">remote</span> = <span class="ruby-node">&quot;/tmp/neptune-input-#{rand(100000)}&quot;</span>
  <span class="ruby-identifier">scp_cmd</span> = <span class="ruby-node">&quot;scp -r #{ssh_args} #{local_file} root@#{shadow_ip}:#{remote}&quot;</span>
  <span class="ruby-comment"># Kernel.puts scp_cmd</span>
  <span class="ruby-constant">CommonFunctions</span>.<span class="ruby-identifier">shell</span>(<span class="ruby-identifier">scp_cmd</span>)

  <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@local&quot;</span>] = <span class="ruby-identifier">remote</span>
  <span class="ruby-comment"># Kernel.puts &quot;job data = #{job_data.inspect}&quot;</span>
  <span class="ruby-identifier">response</span> = <span class="ruby-identifier">controller</span>.<span class="ruby-identifier">put_input</span>(<span class="ruby-identifier">job_data</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">response</span>
    <span class="ruby-keyword">return</span> {<span class="ruby-value">:result</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:success</span>}
  <span class="ruby-keyword">else</span>
    <span class="ruby-comment"># TODO - expand this to include the reason why it failed</span>
    <span class="ruby-keyword">return</span> {<span class="ruby-value">:result</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:failure</span>}
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_input-source -->
          
        </div>

        

        
      </div><!-- get_input-method -->

    
      <div id="method-c-get_job_data" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_job_data</span><span
            class="method-args">(params)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This method takes in a hash in the format that users write neptune/babel
jobs in {:a =&gt; “b”} and converts it to the legacy format that
Neptune used to use {“@a” =&gt; “b”}, and is understood by the
NeptuneManager.</p>
          

          
          <div class="method-source-code" id="get_job_data-source">
            <pre><span class="ruby-comment"># File lib/neptune.rb, line 314</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_job_data</span>(<span class="ruby-identifier">params</span>)
  <span class="ruby-identifier">job_data</span> = {}
  <span class="ruby-identifier">params</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">key</span> = <span class="ruby-node">&quot;@#{k}&quot;</span>
    <span class="ruby-identifier">job_data</span>[<span class="ruby-identifier">key</span>] = <span class="ruby-identifier">v</span>
  }

  <span class="ruby-identifier">job_data</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-string">&quot;@job&quot;</span>)
  <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@keyname&quot;</span>] = <span class="ruby-identifier">params</span>[<span class="ruby-value">:keyname</span>] <span class="ruby-operator">||</span> <span class="ruby-string">&quot;appscale&quot;</span>

  <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@type&quot;</span>] = <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@type&quot;</span>].<span class="ruby-identifier">to_s</span>
  <span class="ruby-identifier">type</span> = <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@type&quot;</span>]

  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">ALLOWED_JOB_TYPES</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">type</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadConfigurationException</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">JOB_TYPE_NOT_ALLOWED</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;upc&quot;</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;x10&quot;</span>
    <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@type&quot;</span>] = <span class="ruby-string">&quot;mpi&quot;</span>
    <span class="ruby-identifier">type</span> = <span class="ruby-string">&quot;mpi&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># kdt jobs also run as mpi jobs, but need to pass along an executable</span>
  <span class="ruby-comment"># parameter to let mpiexec know to use python to exec it</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;kdt&quot;</span>
    <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@type&quot;</span>] = <span class="ruby-string">&quot;mpi&quot;</span>
    <span class="ruby-identifier">type</span> = <span class="ruby-string">&quot;mpi&quot;</span>

    <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@executable&quot;</span>] = <span class="ruby-string">&quot;python&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@nodes_to_use&quot;</span>].<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Hash</span>
    <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@nodes_to_use&quot;</span>] = <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@nodes_to_use&quot;</span>].<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">flatten</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">NO_OUTPUT_NEEDED</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">type</span>)
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@output&quot;</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@output&quot;</span>].<span class="ruby-identifier">empty?</span>)
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadConfigurationException</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&quot;Job output must be specified&quot;</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@output&quot;</span>][<span class="ruby-value">0</span>].<span class="ruby-identifier">chr</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;/&quot;</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadConfigurationException</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&quot;Job output must begin with a slash ('/')&quot;</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">job_data</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_job_data-source -->
          
        </div>

        

        
      </div><!-- get_job_data-method -->

    
      <div id="method-c-get_std_out_and_err" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_std_out_and_err</span><span
            class="method-args">(location)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This method returns a hash containing the standard out and standard error
from a completed job, as well as a result field that indicates whether or
not the job completed successfully (success = no errors).</p>
          

          
          <div class="method-source-code" id="get_std_out_and_err-source">
            <pre><span class="ruby-comment"># File lib/neptune.rb, line 487</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_std_out_and_err</span>(<span class="ruby-identifier">location</span>)
  <span class="ruby-identifier">result</span> = {}

  <span class="ruby-identifier">out</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-node">&quot;#{location}/compile_out&quot;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">read</span>.<span class="ruby-identifier">chomp!</span> }
  <span class="ruby-identifier">result</span>[<span class="ruby-value">:out</span>] = <span class="ruby-identifier">out</span>

  <span class="ruby-identifier">err</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-node">&quot;#{location}/compile_err&quot;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">read</span>.<span class="ruby-identifier">chomp!</span> }
  <span class="ruby-identifier">result</span>[<span class="ruby-value">:err</span>] = <span class="ruby-identifier">err</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">result</span>[<span class="ruby-value">:err</span>]
    <span class="ruby-identifier">result</span>[<span class="ruby-value">:result</span>] = <span class="ruby-value">:failure</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">result</span>[<span class="ruby-value">:result</span>] = <span class="ruby-value">:success</span>
  <span class="ruby-keyword">end</span>    

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_std_out_and_err-source -->
          
        </div>

        

        
      </div><!-- get_std_out_and_err-method -->

    
      <div id="method-c-preprocess_babel" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">preprocess_babel</span><span
            class="method-args">(job_data, controller)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This preprocessing method verifies that the user specified code that should
be run, where the output should be placed, and an engine to run over. It
also verifies that all files to be used are actually reachable. Supported
engines can be found by contacting an AppScale node.</p>
          

          
          <div class="method-source-code" id="preprocess_babel-source">
            <pre><span class="ruby-comment"># File lib/neptune.rb, line 262</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">preprocess_babel</span>(<span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">controller</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_param</span>(<span class="ruby-string">&quot;@code&quot;</span>, <span class="ruby-identifier">job_data</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_param</span>(<span class="ruby-string">&quot;@engine&quot;</span>, <span class="ruby-identifier">job_data</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_param</span>(<span class="ruby-string">&quot;@output&quot;</span>, <span class="ruby-identifier">job_data</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_param</span>(<span class="ruby-string">&quot;@error&quot;</span>, <span class="ruby-identifier">job_data</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_param</span>(<span class="ruby-string">&quot;@metadata&quot;</span>, <span class="ruby-identifier">job_data</span>)

  <span class="ruby-comment"># For most code types, the file's name given is the thing to exec.</span>
  <span class="ruby-comment"># For Java, the actual file to search for is whatever the user gives</span>
  <span class="ruby-comment"># us, with a .class extension.</span>
  <span class="ruby-identifier">code_file_name</span> = <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@code&quot;</span>]
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@executable&quot;</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@executable&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;java&quot;</span>
    <span class="ruby-identifier">code_file_name</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;.class&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_file_to_exist</span>(<span class="ruby-identifier">code_file_name</span>, <span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">controller</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_file_to_not_exist</span>(<span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@output&quot;</span>], <span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">controller</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_file_to_not_exist</span>(<span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@error&quot;</span>], <span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">controller</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_file_to_not_exist</span>(<span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@metadata&quot;</span>], <span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">controller</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@argv&quot;</span>]
    <span class="ruby-identifier">argv</span> = <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@argv&quot;</span>]
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">argv</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">Array</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadConfigurationException</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&quot;argv must be an array&quot;</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">argv</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">arg</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">arg</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">%r\/.*\/.*/</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_file_to_exist</span>(<span class="ruby-identifier">arg</span>, <span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">controller</span>)
      <span class="ruby-keyword">end</span>
    }
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@appcfg_cookies&quot;</span>]
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_file_to_exist</span>(<span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@appcfg_cookies&quot;</span>], <span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">controller</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">user_specified_engine</span> = <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@engine&quot;</span>]

  <span class="ruby-comment"># validate the engine here</span>
  <span class="ruby-identifier">engines</span> = <span class="ruby-identifier">controller</span>.<span class="ruby-identifier">get_supported_babel_engines</span>(<span class="ruby-identifier">job_data</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">engines</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">user_specified_engine</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadConfigurationException</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&quot;The engine you specified, &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot;#{user_specified_engine}, is not a supported engine. Supported engines&quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot; are: #{engines.join(', ')}&quot;</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- preprocess_babel-source -->
          
        </div>

        

        
      </div><!-- preprocess_babel-method -->

    
      <div id="method-c-preprocess_compile" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">preprocess_compile</span><span
            class="method-args">(job_data, controller)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This preprocessing method copies over the user’s code to the Shadow node
so that it can be compiled there. A future version of this method may also
copy over libraries as well.</p>
          

          
          <div class="method-source-code" id="preprocess_compile-source">
            <pre><span class="ruby-comment"># File lib/neptune.rb, line 130</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">preprocess_compile</span>(<span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">controller</span>)
  <span class="ruby-identifier">code</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@code&quot;</span>])
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">code</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadConfigurationException</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;The source file #{code} does not exist.&quot;</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">suffix</span> = <span class="ruby-identifier">code</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">'/'</span>)[<span class="ruby-value">-1</span>]
  <span class="ruby-identifier">dest</span> = <span class="ruby-node">&quot;/tmp/#{suffix}&quot;</span>
  <span class="ruby-identifier">keyname</span> = <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@keyname&quot;</span>]
  <span class="ruby-identifier">shadow_ip</span> = <span class="ruby-constant">CommonFunctions</span>.<span class="ruby-identifier">get_from_yaml</span>(<span class="ruby-identifier">keyname</span>, <span class="ruby-value">:shadow</span>)

  <span class="ruby-identifier">ssh_args</span> = <span class="ruby-node">&quot;-i ~/.appscale/#{keyname}.key -o StrictHostkeyChecking=no root@#{shadow_ip}&quot;</span>
  <span class="ruby-identifier">remove_dir</span> = <span class="ruby-node">&quot;ssh #{ssh_args} 'rm -rf #{dest}' 2&gt;&amp;1&quot;</span>
  <span class="ruby-comment"># Kernel.puts remove_dir</span>
  <span class="ruby-constant">CommonFunctions</span>.<span class="ruby-identifier">shell</span>(<span class="ruby-identifier">remove_dir</span>)
  <span class="ruby-constant">CommonFunctions</span>.<span class="ruby-identifier">scp_to_shadow</span>(<span class="ruby-identifier">code</span>, <span class="ruby-identifier">dest</span>, <span class="ruby-identifier">keyname</span>, <span class="ruby-identifier">is_dir</span>=<span class="ruby-keyword">true</span>)

  <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@code&quot;</span>] = <span class="ruby-identifier">dest</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- preprocess_compile-source -->
          
        </div>

        

        
      </div><!-- preprocess_compile-method -->

    
      <div id="method-c-preprocess_erlang" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">preprocess_erlang</span><span
            class="method-args">(job_data, controller)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This preprocessing method makes sure that the user’s Erlang code exists
and copies it over to the AppScale Shadow node.</p>
          

          
          <div class="method-source-code" id="preprocess_erlang-source">
            <pre><span class="ruby-comment"># File lib/neptune.rb, line 153</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">preprocess_erlang</span>(<span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">controller</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_param</span>(<span class="ruby-string">&quot;@code&quot;</span>, <span class="ruby-identifier">job_data</span>)

  <span class="ruby-identifier">source_code</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@code&quot;</span>])
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">source_code</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadConfigurationException</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;The specified code, #{job_data['@code']},&quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot; didn't exist. Please specify one that exists and try again&quot;</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">dest_code</span> = <span class="ruby-string">&quot;/tmp/&quot;</span>

  <span class="ruby-identifier">keyname</span> = <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@keyname&quot;</span>]
  <span class="ruby-constant">CommonFunctions</span>.<span class="ruby-identifier">scp_to_shadow</span>(<span class="ruby-identifier">source_code</span>, <span class="ruby-identifier">dest_code</span>, <span class="ruby-identifier">keyname</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- preprocess_erlang-source -->
          
        </div>

        

        
      </div><!-- preprocess_erlang-method -->

    
      <div id="method-c-preprocess_mpi" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">preprocess_mpi</span><span
            class="method-args">(job_data, controller)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This preprocessing method verifies that the user specified the number of
nodes to use. If they also specified the number of processes to use, we
also verify that this value is at least as many as the number of nodes
(that is, nodes can’t be underprovisioned in MPI).</p>
          

          
          <div class="method-source-code" id="preprocess_mpi-source">
            <pre><span class="ruby-comment"># File lib/neptune.rb, line 172</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">preprocess_mpi</span>(<span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">controller</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_param</span>(<span class="ruby-string">&quot;@nodes_to_use&quot;</span>, <span class="ruby-identifier">job_data</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_param</span>(<span class="ruby-string">&quot;@procs_to_use&quot;</span>, <span class="ruby-identifier">job_data</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_param</span>(<span class="ruby-string">&quot;@output&quot;</span>, <span class="ruby-identifier">job_data</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_param</span>(<span class="ruby-string">&quot;@error&quot;</span>, <span class="ruby-identifier">job_data</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_param</span>(<span class="ruby-string">&quot;@metadata&quot;</span>, <span class="ruby-identifier">job_data</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@procs_to_use&quot;</span>]
    <span class="ruby-identifier">p</span> = <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@procs_to_use&quot;</span>]
    <span class="ruby-identifier">n</span> = <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@nodes_to_use&quot;</span>]
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">n</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadConfigurationException</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&quot;:procs_to_use must be at least as &quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-string">&quot;large as :nodes_to_use.&quot;</span>) 
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@argv&quot;</span>]
    <span class="ruby-identifier">argv</span> = <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@argv&quot;</span>]

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">argv</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">String</span>
      <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@argv&quot;</span>] = <span class="ruby-identifier">argv</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">argv</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Array</span>
      <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@argv&quot;</span>] = <span class="ruby-identifier">argv</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">' '</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadConfigurationException</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&quot;:argv must be either a String or Array&quot;</span>) 
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">job_data</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- preprocess_mpi-source -->
          
        </div>

        

        
      </div><!-- preprocess_mpi-method -->

    
      <div id="method-c-preprocess_ssa" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">preprocess_ssa</span><span
            class="method-args">(job_data, controller)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This preprocessing method verifies that the user specified the number of
trajectories to run, via either :trajectories or :simulations. Both should
not be specified - only one or the other, and regardless of which they
specify, convert it to be :trajectories.</p>
          

          
          <div class="method-source-code" id="preprocess_ssa-source">
            <pre><span class="ruby-comment"># File lib/neptune.rb, line 208</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">preprocess_ssa</span>(<span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">controller</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@simulations&quot;</span>] <span class="ruby-keyword">and</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@trajectories&quot;</span>]
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadConfigurationException</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&quot;:simulations and :trajectories &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;not both be specified.&quot;</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@simulations&quot;</span>]
    <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@trajectories&quot;</span>] = <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@simulations&quot;</span>]
    <span class="ruby-identifier">job_data</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-string">&quot;@simulations&quot;</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_param</span>(<span class="ruby-string">&quot;@trajectories&quot;</span>, <span class="ruby-identifier">job_data</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">job_data</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- preprocess_ssa-source -->
          
        </div>

        

        
      </div><!-- preprocess_ssa-method -->

    
      <div id="method-c-require_file_to_exist" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">require_file_to_exist</span><span
            class="method-args">(file, job_data, controller)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This helper method asks the NeptuneManager if the named file exists, and if
it does not, throws an exception.</p>
          

          
          <div class="method-source-code" id="require_file_to_exist-source">
            <pre><span class="ruby-comment"># File lib/neptune.rb, line 235</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_file_to_exist</span>(<span class="ruby-identifier">file</span>, <span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">controller</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">controller</span>.<span class="ruby-identifier">does_file_exist?</span>(<span class="ruby-identifier">file</span>, <span class="ruby-identifier">job_data</span>)
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">FileNotFoundException</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;Expecting file #{file} to exist &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;in the remote datastore, which did not exist.&quot;</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- require_file_to_exist-source -->
          
        </div>

        

        
      </div><!-- require_file_to_exist-method -->

    
      <div id="method-c-require_file_to_not_exist" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">require_file_to_not_exist</span><span
            class="method-args">(file, job_data, controller)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This helper method performs the opposite function of <a
href="NeptuneHelper.html#method-c-require_file_to_exist">::require_file_to_exist</a>,
raising an exception if the named file does exist.</p>
          

          
          <div class="method-source-code" id="require_file_to_not_exist-source">
            <pre><span class="ruby-comment"># File lib/neptune.rb, line 247</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_file_to_not_exist</span>(<span class="ruby-identifier">file</span>, <span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">controller</span>)
  <span class="ruby-keyword">begin</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_file_to_exist</span>(<span class="ruby-identifier">file</span>, <span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">controller</span>)
    <span class="ruby-comment"># no exception thrown previously means that the output file exists</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadConfigurationException</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">'Output specified already exists'</span>)
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">FileNotFoundException</span>
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- require_file_to_not_exist-source -->
          
        </div>

        

        
      </div><!-- require_file_to_not_exist-method -->

    
      <div id="method-c-require_param" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">require_param</span><span
            class="method-args">(param, job_data)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This helper method aborts if the given parameter is not present in the job
data provided.</p>
          

          
          <div class="method-source-code" id="require_param-source">
            <pre><span class="ruby-comment"># File lib/neptune.rb, line 226</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">require_param</span>(<span class="ruby-identifier">param</span>, <span class="ruby-identifier">job_data</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">job_data</span>[<span class="ruby-identifier">param</span>]
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadConfigurationException</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;#{param} must be specified&quot;</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- require_param-source -->
          
        </div>

        

        
      </div><!-- require_param-method -->

    
      <div id="method-c-run_job" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">run_job</span><span
            class="method-args">(job_data, ssh_args, shadow_ip, secret)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This method actually runs the Neptune job, given information about the job
as well as information about the node to send the request to.</p>
          

          
          <div class="method-source-code" id="run_job-source">
            <pre><span class="ruby-comment"># File lib/neptune.rb, line 537</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">run_job</span>(<span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">ssh_args</span>, <span class="ruby-identifier">shadow_ip</span>, <span class="ruby-identifier">secret</span>)
  <span class="ruby-identifier">controller</span> = <span class="ruby-constant">NeptuneManagerClient</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">shadow_ip</span>, <span class="ruby-identifier">secret</span>)

  <span class="ruby-comment"># TODO - right now the job is assumed to succeed in many cases</span>
  <span class="ruby-comment"># need to investigate the various failure scenarios</span>
  <span class="ruby-identifier">result</span> = { <span class="ruby-value">:result</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:success</span> }

  <span class="ruby-keyword">case</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@type&quot;</span>]
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;input&quot;</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_input</span>(<span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">ssh_args</span>, <span class="ruby-identifier">shadow_ip</span>, <span class="ruby-identifier">controller</span>)
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;output&quot;</span>
    <span class="ruby-identifier">result</span>[<span class="ruby-value">:output</span>] = <span class="ruby-identifier">controller</span>.<span class="ruby-identifier">get_output</span>(<span class="ruby-identifier">job_data</span>)
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;get-acl&quot;</span>
    <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@type&quot;</span>] = <span class="ruby-string">&quot;acl&quot;</span>
    <span class="ruby-identifier">result</span>[<span class="ruby-value">:acl</span>] = <span class="ruby-identifier">controller</span>.<span class="ruby-identifier">get_acl</span>(<span class="ruby-identifier">job_data</span>)
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;set-acl&quot;</span>
    <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@type&quot;</span>] = <span class="ruby-string">&quot;acl&quot;</span>
    <span class="ruby-identifier">result</span>[<span class="ruby-value">:acl</span>] = <span class="ruby-identifier">controller</span>.<span class="ruby-identifier">set_acl</span>(<span class="ruby-identifier">job_data</span>)
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;compile&quot;</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">compile_code</span>(<span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">ssh_args</span>, <span class="ruby-identifier">shadow_ip</span>)
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;cicero&quot;</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">upload_app_for_cicero</span>(<span class="ruby-identifier">job_data</span>)
    <span class="ruby-identifier">msg</span> = <span class="ruby-identifier">controller</span>.<span class="ruby-identifier">start_neptune_job</span>(<span class="ruby-identifier">job_data</span>)
    <span class="ruby-identifier">result</span>[<span class="ruby-value">:msg</span>] = <span class="ruby-identifier">msg</span>
    <span class="ruby-identifier">result</span>[<span class="ruby-value">:result</span>] = <span class="ruby-value">:failure</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">result</span>[<span class="ruby-value">:msg</span>] <span class="ruby-operator">!~</span> <span class="ruby-regexp">%rjob is now running\Z/</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">msg</span> = <span class="ruby-identifier">controller</span>.<span class="ruby-identifier">start_neptune_job</span>(<span class="ruby-identifier">job_data</span>)
    <span class="ruby-identifier">result</span>[<span class="ruby-value">:msg</span>] = <span class="ruby-identifier">msg</span>
    <span class="ruby-identifier">result</span>[<span class="ruby-value">:result</span>] = <span class="ruby-value">:failure</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">result</span>[<span class="ruby-value">:msg</span>] <span class="ruby-operator">!~</span> <span class="ruby-regexp">%rjob is now running\Z/</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- run_job-source -->
          
        </div>

        

        
      </div><!-- run_job-method -->

    
      <div id="method-c-upload_app_for_cicero" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">upload_app_for_cicero</span><span
            class="method-args">(job_data)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This method uploads a Google App Engine application into AppScale, for use
with Cicero jobs. It requires the AppScale tools to be installed.</p>
          

          
          <div class="method-source-code" id="upload_app_for_cicero-source">
            <pre><span class="ruby-comment"># File lib/neptune.rb, line 508</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">upload_app_for_cicero</span>(<span class="ruby-identifier">job_data</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@app&quot;</span>]
    <span class="ruby-comment"># Kernel.puts &quot;No app specified, not uploading...&quot; </span>
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">app_location</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@app&quot;</span>])
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">app_location</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadConfigurationException</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;The app you specified, #{app_location}, does not exist.&quot;</span> <span class="ruby-operator">+</span> 
      <span class="ruby-string">&quot;Please specify one that does and try again.&quot;</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">keyname</span> = <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@keyname&quot;</span>] <span class="ruby-operator">||</span> <span class="ruby-string">&quot;appscale&quot;</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@appscale_tools&quot;</span>]
    <span class="ruby-identifier">upload_app</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@appscale_tools&quot;</span>]) <span class="ruby-operator">+</span>
      <span class="ruby-constant">File</span><span class="ruby-operator">::</span><span class="ruby-constant">SEPARATOR</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot;bin&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-constant">File</span><span class="ruby-operator">::</span><span class="ruby-constant">SEPARATOR</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot;appscale-upload-app&quot;</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">upload_app</span> = <span class="ruby-string">&quot;appscale-upload-app&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Kernel.puts &quot;Uploading AppEngine app at #{app_location}&quot;</span>
  <span class="ruby-identifier">upload_command</span> = <span class="ruby-node">&quot;#{upload_app} --file #{app_location} --test --keyname #{keyname}&quot;</span>
  <span class="ruby-comment"># Kernel.puts upload_command</span>
  <span class="ruby-comment"># Kernel.puts `#{upload_command}`</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- upload_app_for_cicero-source -->
          
        </div>

        

        
      </div><!-- upload_app_for_cicero-method -->

    
      <div id="method-c-validate_storage_params" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">validate_storage_params</span><span
            class="method-args">(job_data)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This method looks through the given job data and makes sure that the
correct parameters are present for the storage mechanism specified. It
throws an exception if there are errors in the job data or if a needed
parameter is missing.</p>
          

          
          <div class="method-source-code" id="validate_storage_params-source">
            <pre><span class="ruby-comment"># File lib/neptune.rb, line 367</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">validate_storage_params</span>(<span class="ruby-identifier">job_data</span>)
  <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@storage&quot;</span>] <span class="ruby-operator">||=</span> <span class="ruby-string">&quot;appdb&quot;</span>

  <span class="ruby-identifier">storage</span> = <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@storage&quot;</span>]
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">ALLOWED_STORAGE_TYPES</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">storage</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadConfigurationException</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&quot;Supported storage types are &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot;#{ALLOWED_STORAGE_TYPES.join(', ')} - #{storage} is not supported.&quot;</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Our implementation for storing / retrieving via Google Storage</span>
  <span class="ruby-comment"># and Walrus uses</span>
  <span class="ruby-comment"># the same library as we do for S3 - so just tell it that it's S3</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">storage</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;gstorage&quot;</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">storage</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;walrus&quot;</span>
    <span class="ruby-identifier">storage</span> = <span class="ruby-string">&quot;s3&quot;</span>
    <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@storage&quot;</span>] = <span class="ruby-string">&quot;s3&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">storage</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;s3&quot;</span>
    [<span class="ruby-string">&quot;EC2_ACCESS_KEY&quot;</span>, <span class="ruby-string">&quot;EC2_SECRET_KEY&quot;</span>, <span class="ruby-string">&quot;S3_URL&quot;</span>].<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-node">&quot;@#{item}&quot;</span>]
        <span class="ruby-comment"># Kernel.puts &quot;Using specified #{item}&quot;</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-keyword">if</span> <span class="ruby-constant">ENV</span>[<span class="ruby-identifier">item</span>]
          <span class="ruby-comment"># Kernel.puts &quot;Using #{item} from environment&quot;</span>
          <span class="ruby-identifier">job_data</span>[<span class="ruby-node">&quot;@#{item}&quot;</span>] = <span class="ruby-constant">ENV</span>[<span class="ruby-identifier">item</span>]
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadConfigurationException</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;When storing data to S3, #{item} must be specified or be in &quot;</span> <span class="ruby-operator">+</span> 
            <span class="ruby-string">&quot;your environment. Please do so and try again.&quot;</span>)
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    }
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">job_data</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- validate_storage_params-source -->
          
        </div>

        

        
      </div><!-- validate_storage_params-method -->

    
      <div id="method-c-wait_for_compilation_to_finish" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">wait_for_compilation_to_finish</span><span
            class="method-args">(ssh_args, shadow_ip, compiled_location)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This method waits for AppScale to finish compiling the user’s code,
indicated by AppScale copying the finished code to a pre-determined
location.</p>
          

          
          <div class="method-source-code" id="wait_for_compilation_to_finish-source">
            <pre><span class="ruby-comment"># File lib/neptune.rb, line 438</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">wait_for_compilation_to_finish</span>(<span class="ruby-identifier">ssh_args</span>, <span class="ruby-identifier">shadow_ip</span>, <span class="ruby-identifier">compiled_location</span>)
  <span class="ruby-identifier">loop</span> {
    <span class="ruby-identifier">ssh_command</span> = <span class="ruby-node">&quot;ssh #{ssh_args} root@#{shadow_ip} 'ls #{compiled_location}' 2&gt;&amp;1&quot;</span>
    <span class="ruby-comment"># Kernel.puts ssh_command</span>
    <span class="ruby-identifier">ssh_result</span> = <span class="ruby-constant">CommonFunctions</span>.<span class="ruby-identifier">shell</span>(<span class="ruby-identifier">ssh_command</span>)
    <span class="ruby-comment"># Kernel.puts &quot;result was [#{ssh_result}]&quot;</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">ssh_result</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">%rNo such file or directory/</span>
      <span class="ruby-comment"># Kernel.puts &quot;Still waiting for code to be compiled...&quot;</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-comment"># Kernel.puts &quot;compilation complete! Copying compiled code to #{copy_to}&quot;</span>
      <span class="ruby-keyword">return</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">sleep</span>(<span class="ruby-value">5</span>)
  }
<span class="ruby-keyword">end</span></pre>
          </div><!-- wait_for_compilation_to_finish-source -->
          
        </div>

        

        
      </div><!-- wait_for_compilation_to_finish-method -->

    
    </section><!-- public-class-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

