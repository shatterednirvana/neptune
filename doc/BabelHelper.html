<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>module BabelHelper - RDoc Documentation</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="module">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>lib/babel.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    
    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-c-check_output_files">::check_output_files</a>
    
    <li><a href="#method-c-convert_from_neptune_params">::convert_from_neptune_params</a>
    
    <li><a href="#method-c-convert_to_neptune_params">::convert_to_neptune_params</a>
    
    <li><a href="#method-c-ensure_output_does_not_exist">::ensure_output_does_not_exist</a>
    
    <li><a href="#method-c-generate_output_location">::generate_output_location</a>
    
    <li><a href="#method-c-get_bucket_for_local_data">::get_bucket_for_local_data</a>
    
    <li><a href="#method-c-get_neptune_manager_client">::get_neptune_manager_client</a>
    
    <li><a href="#method-c-put_code">::put_code</a>
    
    <li><a href="#method-c-put_file">::put_file</a>
    
    <li><a href="#method-c-put_inputs">::put_inputs</a>
    
    <li><a href="#method-c-run_job">::run_job</a>
    
    <li><a href="#method-c-validate_inputs">::validate_inputs</a>
    
    <li><a href="#method-c-wait_and_get_output">::wait_and_get_output</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    
    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./BabelHelper.html">BabelHelper</a>
  
    <li><a href="./BadConfigurationException.html">BadConfigurationException</a>
  
    <li><a href="./CommonFunctions.html">CommonFunctions</a>
  
    <li><a href="./ExodusHelper.html">ExodusHelper</a>
  
    <li><a href="./ExodusTaskInfo.html">ExodusTaskInfo</a>
  
    <li><a href="./FileNotFoundException.html">FileNotFoundException</a>
  
    <li><a href="./NeptuneHelper.html">NeptuneHelper</a>
  
    <li><a href="./NeptuneManagerClient.html">NeptuneManagerClient</a>
  
    <li><a href="./NeptuneManagerException.html">NeptuneManagerException</a>
  
    <li><a href="./Object.html">Object</a>
  
    <li><a href="./TaskInfo.html">TaskInfo</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="module">module BabelHelper</h1>

  <div id="description" class="description">
    
<p>This module provides convenience functions for babel().</p>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    <!-- Methods -->
    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-check_output_files" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">check_output_files</span><span
            class="method-args">(job_data)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>babel() callers do not have to specify a location where the standard output
and error the task produces should be placed. If they don’t, generate
locations for them and make sure they don’t exist beforehand.</p>
          

          
          <div class="method-source-code" id="check_output_files-source">
            <pre><span class="ruby-comment"># File lib/babel.rb, line 145</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">check_output_files</span>(<span class="ruby-identifier">job_data</span>)
  [<span class="ruby-string">&quot;@output&quot;</span>, <span class="ruby-string">&quot;@error&quot;</span>, <span class="ruby-string">&quot;@metadata&quot;</span>].<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-identifier">item</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-identifier">item</span>].<span class="ruby-identifier">empty?</span>
      <span class="ruby-identifier">job_data</span>[<span class="ruby-identifier">item</span>] = <span class="ruby-constant">BabelHelper</span>.<span class="ruby-identifier">generate_output_location</span>(<span class="ruby-identifier">job_data</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-constant">BabelHelper</span>.<span class="ruby-identifier">ensure_output_does_not_exist</span>(<span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">job_data</span>[<span class="ruby-identifier">item</span>])
  }
<span class="ruby-keyword">end</span></pre>
          </div><!-- check_output_files-source -->
          
        </div>

        

        
      </div><!-- check_output_files-method -->

    
      <div id="method-c-convert_from_neptune_params" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">convert_from_neptune_params</span><span
            class="method-args">(params)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Neptune internally uses job_data with keys of the form @name, but since the
user has given them to us in the form :name, we convert it here. TODO(cgb):
It looks like this conversion to/from may be unnecessary since neptune()
just re-converts it - how can we remove it?</p>
          

          
          <div class="method-source-code" id="convert_from_neptune_params-source">
            <pre><span class="ruby-comment"># File lib/babel.rb, line 255</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">convert_from_neptune_params</span>(<span class="ruby-identifier">params</span>)
  <span class="ruby-identifier">job_data</span> = {}
  <span class="ruby-identifier">params</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">key</span> = <span class="ruby-node">&quot;@#{k}&quot;</span>
    <span class="ruby-identifier">job_data</span>[<span class="ruby-identifier">key</span>] = <span class="ruby-identifier">v</span>
  }
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">job_data</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- convert_from_neptune_params-source -->
          
        </div>

        

        
      </div><!-- convert_from_neptune_params-method -->

    
      <div id="method-c-convert_to_neptune_params" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">convert_to_neptune_params</span><span
            class="method-args">(job_data)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Neptune input jobs expect keys of the form :name, but since we’ve already
converted them to the form @name, this function reverses that conversion.</p>
          

          
          <div class="method-source-code" id="convert_to_neptune_params-source">
            <pre><span class="ruby-comment"># File lib/babel.rb, line 267</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">convert_to_neptune_params</span>(<span class="ruby-identifier">job_data</span>)
  <span class="ruby-identifier">neptune_params</span> = {}

  <span class="ruby-identifier">job_data</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">key</span> = <span class="ruby-identifier">k</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-string">&quot;@&quot;</span>).<span class="ruby-identifier">to_sym</span>
    <span class="ruby-identifier">neptune_params</span>[<span class="ruby-identifier">key</span>] = <span class="ruby-identifier">v</span>
  }

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">neptune_params</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- convert_to_neptune_params-source -->
          
        </div>

        

        
      </div><!-- convert_to_neptune_params-method -->

    
      <div id="method-c-ensure_output_does_not_exist" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">ensure_output_does_not_exist</span><span
            class="method-args">(job_data, remote_file)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>To avoid accidentally overwriting outputs from previous jobs, we first
check to make sure an output file doesn’t exist before starting a new job
with the given name.</p>
          

          
          <div class="method-source-code" id="ensure_output_does_not_exist-source">
            <pre><span class="ruby-comment"># File lib/babel.rb, line 180</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">ensure_output_does_not_exist</span>(<span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">remote_file</span>)
  <span class="ruby-identifier">controller</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_neptune_manager_client</span>(<span class="ruby-identifier">job_data</span>)
  <span class="ruby-constant">NeptuneHelper</span>.<span class="ruby-identifier">require_file_to_not_exist</span>(<span class="ruby-identifier">remote_file</span>, <span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">controller</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- ensure_output_does_not_exist-source -->
          
        </div>

        

        
      </div><!-- ensure_output_does_not_exist-method -->

    
      <div id="method-c-generate_output_location" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">generate_output_location</span><span
            class="method-args">(job_data)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>If the user fails to give us an output location, this function will
generate one for them, based on either the location of their code (for
remotely specified code), or a babel parameter (for locally specified
code).</p>
          

          
          <div class="method-source-code" id="generate_output_location-source">
            <pre><span class="ruby-comment"># File lib/babel.rb, line 109</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">generate_output_location</span>(<span class="ruby-identifier">job_data</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@is_remote&quot;</span>]
    <span class="ruby-comment"># We already know the bucket name - the same one that the user</span>
    <span class="ruby-comment"># has told us their code is located in.</span>
    <span class="ruby-identifier">prefix</span> = <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@code&quot;</span>].<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">%r\/(.*?)\//</span>)[<span class="ruby-value">0</span>].<span class="ruby-identifier">to_s</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">prefix</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_bucket_for_local_data</span>(<span class="ruby-identifier">job_data</span>)
  <span class="ruby-keyword">end</span>
    
  <span class="ruby-keyword">return</span> <span class="ruby-node">&quot;/#{prefix}/babel/temp-#{CommonFunctions.get_random_alphanumeric()}&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- generate_output_location-source -->
          
        </div>

        

        
      </div><!-- generate_output_location-method -->

    
      <div id="method-c-get_bucket_for_local_data" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_bucket_for_local_data</span><span
            class="method-args">(job_data)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Provides a common way for callers to get the name of the bucket that should
be used for Neptune jobs where the code is stored locally.</p>
          

          
          <div class="method-source-code" id="get_bucket_for_local_data-source">
            <pre><span class="ruby-comment"># File lib/babel.rb, line 124</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_bucket_for_local_data</span>(<span class="ruby-identifier">job_data</span>)
  <span class="ruby-identifier">bucket_name</span> = <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@bucket_name&quot;</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">'BABEL_BUCKET_NAME'</span>] <span class="ruby-operator">||</span>
    <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@S3_bucket_name&quot;</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@Walrus_bucket_name&quot;</span>] <span class="ruby-operator">||</span>
    <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@GStorage_bucket_name&quot;</span>]

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">bucket_name</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadConfigurationException</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">NEEDS_BUCKET_INFO</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># If the bucket name starts with a slash, remove it</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">bucket_name</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">chr</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;/&quot;</span>
    <span class="ruby-identifier">bucket_name</span> = <span class="ruby-identifier">bucket_name</span>[<span class="ruby-value">1</span>, <span class="ruby-identifier">bucket_name</span>.<span class="ruby-identifier">length</span>]
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">bucket_name</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_bucket_for_local_data-source -->
          
        </div>

        

        
      </div><!-- get_bucket_for_local_data-method -->

    
      <div id="method-c-get_neptune_manager_client" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_neptune_manager_client</span><span
            class="method-args">(job_data)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns an <a href="NeptuneManagerClient.html">NeptuneManagerClient</a> for
the given job data.</p>
          

          
          <div class="method-source-code" id="get_neptune_manager_client-source">
            <pre><span class="ruby-comment"># File lib/babel.rb, line 187</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_neptune_manager_client</span>(<span class="ruby-identifier">job_data</span>)
  <span class="ruby-identifier">keyname</span> = <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@keyname&quot;</span>] <span class="ruby-operator">||</span> <span class="ruby-string">&quot;appscale&quot;</span>
  <span class="ruby-identifier">shadow_ip</span> = <span class="ruby-constant">CommonFunctions</span>.<span class="ruby-identifier">get_from_yaml</span>(<span class="ruby-identifier">keyname</span>, <span class="ruby-value">:shadow</span>)
  <span class="ruby-identifier">secret</span> = <span class="ruby-constant">CommonFunctions</span>.<span class="ruby-identifier">get_secret_key</span>(<span class="ruby-identifier">keyname</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-constant">NeptuneManagerClient</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">shadow_ip</span>, <span class="ruby-identifier">secret</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_neptune_manager_client-source -->
          
        </div>

        

        
      </div><!-- get_neptune_manager_client-method -->

    
      <div id="method-c-put_code" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">put_code</span><span
            class="method-args">(job_data)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Stores the user’s code (and the directory it’s in, and directories in
the same directory as the user’s code, since there could be libraries
used) in the remote datastore.</p>
          

          
          <div class="method-source-code" id="put_code-source">
            <pre><span class="ruby-comment"># File lib/babel.rb, line 198</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">put_code</span>(<span class="ruby-identifier">job_data</span>)
  <span class="ruby-identifier">code_dir</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">dirname</span>(<span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@code&quot;</span>])
  <span class="ruby-identifier">code</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">basename</span>(<span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@code&quot;</span>])
  <span class="ruby-identifier">remote_code_dir</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">put_file</span>(<span class="ruby-identifier">code_dir</span>, <span class="ruby-identifier">job_data</span>)
  <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@code&quot;</span>] = <span class="ruby-identifier">remote_code_dir</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot;/&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">code</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@code&quot;</span>]
<span class="ruby-keyword">end</span></pre>
          </div><!-- put_code-source -->
          
        </div>

        

        
      </div><!-- put_code-method -->

    
      <div id="method-c-put_file" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">put_file</span><span
            class="method-args">(local_path, job_data)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>If the user gives us local code or local inputs, this function will run a
Neptune ‘input’ job to store the data remotely.</p>
          

          
          <div class="method-source-code" id="put_file-source">
            <pre><span class="ruby-comment"># File lib/babel.rb, line 229</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">put_file</span>(<span class="ruby-identifier">local_path</span>, <span class="ruby-identifier">job_data</span>)
  <span class="ruby-identifier">input_data</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">convert_to_neptune_params</span>(<span class="ruby-identifier">job_data</span>)
  <span class="ruby-identifier">input_data</span>[<span class="ruby-value">:type</span>] = <span class="ruby-string">&quot;input&quot;</span>
  <span class="ruby-identifier">input_data</span>[<span class="ruby-value">:local</span>] = <span class="ruby-identifier">local_path</span>

  <span class="ruby-identifier">bucket_name</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_bucket_for_local_data</span>(<span class="ruby-identifier">job_data</span>)
  <span class="ruby-identifier">input_data</span>[<span class="ruby-value">:remote</span>] = <span class="ruby-node">&quot;/#{bucket_name}/babel#{local_path}&quot;</span>

  <span class="ruby-identifier">start</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
  <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">neptune</span>(<span class="ruby-identifier">input_data</span>)
  <span class="ruby-identifier">fin</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
  
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-string">'@metadata_info'</span>].<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">job_data</span>[<span class="ruby-string">'@metadata_info'</span>] = {<span class="ruby-string">'time_to_store_inputs'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0.0</span>}
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">job_data</span>[<span class="ruby-string">'@metadata_info'</span>][<span class="ruby-string">'time_to_store_inputs'</span>] <span class="ruby-operator">+=</span> <span class="ruby-identifier">fin</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">start</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">input_data</span>[<span class="ruby-value">:remote</span>]
<span class="ruby-keyword">end</span></pre>
          </div><!-- put_file-source -->
          
        </div>

        

        
      </div><!-- put_file-method -->

    
      <div id="method-c-put_inputs" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">put_inputs</span><span
            class="method-args">(job_data)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>If any input files are specified, they are copied to the remote datastore
via Neptune ‘input’ jobs. Inputs are assumed to be files on the local
filesystem if they begin with a slash, and job_data gets updated with the
remote location of these files.</p>
          

          
          <div class="method-source-code" id="put_inputs-source">
            <pre><span class="ruby-comment"># File lib/babel.rb, line 211</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">put_inputs</span>(<span class="ruby-identifier">job_data</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@argv&quot;</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@argv&quot;</span>].<span class="ruby-identifier">empty?</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">job_data</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@argv&quot;</span>].<span class="ruby-identifier">each_index</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">arg</span> = <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@argv&quot;</span>][<span class="ruby-identifier">i</span>]
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">arg</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">chr</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;/&quot;</span>
      <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@argv&quot;</span>][<span class="ruby-identifier">i</span>] = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">put_file</span>(<span class="ruby-identifier">arg</span>, <span class="ruby-identifier">job_data</span>)
    <span class="ruby-keyword">end</span>
  }

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">job_data</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- put_inputs-source -->
          
        </div>

        

        
      </div><!-- put_inputs-method -->

    
      <div id="method-c-run_job" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">run_job</span><span
            class="method-args">(job_data_list)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Constructs a Neptune job to run the user’s code as a Babel job (task
queue) from the given parameters.</p>
          

          
          <div class="method-source-code" id="run_job-source">
            <pre><span class="ruby-comment"># File lib/babel.rb, line 281</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">run_job</span>(<span class="ruby-identifier">job_data_list</span>)
  <span class="ruby-identifier">run_data_list</span> = []

  <span class="ruby-identifier">job_data_list</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">job_data</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">run_data</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">convert_to_neptune_params</span>(<span class="ruby-identifier">job_data</span>)

    <span class="ruby-comment"># Default to babel as the job type, if the user doesn't specify one.</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">run_data</span>[<span class="ruby-value">:type</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">run_data</span>[<span class="ruby-value">:type</span>].<span class="ruby-identifier">empty?</span>
      <span class="ruby-identifier">run_data</span>[<span class="ruby-value">:type</span>] = <span class="ruby-string">&quot;babel&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># TODO(cgb): Once AppScale+Babel gets support for RabbitMQ, change this to</span>
    <span class="ruby-comment"># exec tasks over it, instead of locally.</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@run_local&quot;</span>].<span class="ruby-identifier">nil?</span>
      <span class="ruby-identifier">run_data</span>[<span class="ruby-value">:run_local</span>] = <span class="ruby-keyword">true</span>
      <span class="ruby-identifier">run_data</span>[<span class="ruby-value">:engine</span>] = <span class="ruby-string">&quot;executor-sqs&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">run_data</span>[<span class="ruby-value">:failed_attempts</span>] = <span class="ruby-value">0</span>
    <span class="ruby-identifier">run_data_list</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">run_data</span>
  }

  <span class="ruby-identifier">loop</span> {
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">run_data_list</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
      <span class="ruby-identifier">run_job</span> = <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">neptune</span>(<span class="ruby-identifier">run_data_list</span>[<span class="ruby-value">0</span>])
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">run_job</span> = <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">neptune</span>(<span class="ruby-identifier">run_data_list</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">run_job</span>[<span class="ruby-value">:result</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:success</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">run_job</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">run_data_list</span>[<span class="ruby-value">0</span>][<span class="ruby-value">:failed_attempts</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
      <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-constant">SLEEP_TIME</span>)  <span class="ruby-comment"># TODO(cgb): this should exponentially backoff</span>
    <span class="ruby-keyword">end</span>
  }
<span class="ruby-keyword">end</span></pre>
          </div><!-- run_job-source -->
          
        </div>

        

        
      </div><!-- run_job-method -->

    
      <div id="method-c-validate_inputs" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">validate_inputs</span><span
            class="method-args">(job_data)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>For jobs where the code is stored remotely, this method ensures that  the
code and any possible inputs actually do exist, before attempting to use
them for computation.</p>
          

          
          <div class="method-source-code" id="validate_inputs-source">
            <pre><span class="ruby-comment"># File lib/babel.rb, line 158</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">validate_inputs</span>(<span class="ruby-identifier">job_data</span>)
  <span class="ruby-identifier">controller</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_neptune_manager_client</span>(<span class="ruby-identifier">job_data</span>)

  <span class="ruby-comment"># First, make sure the code exists</span>
  <span class="ruby-constant">NeptuneHelper</span>.<span class="ruby-identifier">require_file_to_exist</span>(<span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@code&quot;</span>], <span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">controller</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@argv&quot;</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@argv&quot;</span>].<span class="ruby-identifier">empty?</span>
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># We assume anything that begins with a slash is a remote file</span>
  <span class="ruby-identifier">job_data</span>[<span class="ruby-string">&quot;@argv&quot;</span>].<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">arg</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">arg</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">chr</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;/&quot;</span>
      <span class="ruby-constant">NeptuneHelper</span>.<span class="ruby-identifier">require_file_to_exist</span>(<span class="ruby-identifier">arg</span>, <span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">controller</span>)
    <span class="ruby-keyword">end</span>
  }
<span class="ruby-keyword">end</span></pre>
          </div><!-- validate_inputs-source -->
          
        </div>

        

        
      </div><!-- validate_inputs-method -->

    
      <div id="method-c-wait_and_get_output" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">wait_and_get_output</span><span
            class="method-args">(job_data, output_location)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Constructs a Neptune job to get the output of a Babel job. If the job is
not yet finished, this function waits until it does, and then returns the
output of the job.</p>
          

          
          <div class="method-source-code" id="wait_and_get_output-source">
            <pre><span class="ruby-comment"># File lib/babel.rb, line 323</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">wait_and_get_output</span>(<span class="ruby-identifier">job_data</span>, <span class="ruby-identifier">output_location</span>)
  <span class="ruby-identifier">output_data</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">convert_to_neptune_params</span>(<span class="ruby-identifier">job_data</span>)
  <span class="ruby-identifier">output_data</span>[<span class="ruby-value">:type</span>] = <span class="ruby-string">&quot;output&quot;</span>
  <span class="ruby-identifier">output_data</span>[<span class="ruby-value">:output</span>] = <span class="ruby-identifier">output_location</span>

  <span class="ruby-identifier">output</span> = <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-identifier">time_to_sleep</span> = <span class="ruby-constant">SLEEP_TIME</span>
  <span class="ruby-identifier">loop</span> {
    <span class="ruby-identifier">output</span> = <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">neptune</span>(<span class="ruby-identifier">output_data</span>)[<span class="ruby-value">:output</span>]
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">output</span> <span class="ruby-operator">==</span> <span class="ruby-constant">DOES_NOT_EXIST</span>
      <span class="ruby-comment"># Exponentially back off, up to a limit of MAX_SLEEP_TIME</span>
      <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">sleep</span>(<span class="ruby-identifier">time_to_sleep</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">time_to_sleep</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">MAX_SLEEP_TIME</span>
        <span class="ruby-identifier">time_to_sleep</span> <span class="ruby-operator">*=</span> <span class="ruby-value">2</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">break</span>
    <span class="ruby-keyword">end</span>
  }

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">output</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- wait_and_get_output-source -->
          
        </div>

        

        
      </div><!-- wait_and_get_output-method -->

    
    </section><!-- public-class-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

